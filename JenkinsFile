pipeline {
    agent { label 'QA' }
    stages {
        stage('Build') {
            steps {
                sh 'export NVM_DIR="/home/azureuser/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh" && nvm install 22 && nvm alias default 22 && nvm use 22'
                sh 'cp -r /home/azureuser/configfiles/clarient/frontend/.env .env'
                sh 'yarn install'
                sh 'yarn build'
            }
        }
        stage('Deploy') {
            steps {
                sh 'export NVM_DIR="/home/azureuser/.nvm" && [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh" && nvm use 22'
                sh 'pm2 restart clarient-web || pm2 start yarn --interpreter bash --name "clarient-web" -- start -p 4051'
            }
        }
    }
}
